#!/bin/sh
#
# Point-to-point network setup script
# 
# This script was automagically generated by './makeptpscript',
#  from the configuration file 'ptp.conf'.
# If you modify it by hand you will eventually lose your changes.
#


# wait until remote node's net is up, then grab netmap
#   $1=node  $2=net
grab_netmap()
{
  echo "Waiting for Node $1, Net $2"
  until netinfo -n$1 -L$2 > /dev/null ; do
    sleep 1
  done
  echo "Grabbing netmap from Node $1"
  netmap -n$1 | sed -e "s^mask^    ^" | netmap -F -
}


# mask all entries for a node, then unmask the 'right' one
#   $1=node  $2=good net
mask_unmask()
{
  echo "Waiting for Node $1 to see us"
  until netmap -n$1 | grep -E " $NODE *$2" > /dev/null ; do
    sleep 1
  done
  echo "Masking Node $1, Net $2"
  netmap -m "mask $1"
  netmap -m "unmask $1 $2"
}


echo Setting up point-to-point network...

# Node 5
if [ $NODE -eq 5 ]; then   
   Net.speedo -r101000000 -I0 -l10 &
   Net.speedo -r101000000 -I1 -l11 &
   Net.speedo -r101000000 -I2 -l12 &
   sleep 1
   grab_netmap 6 10
   grab_netmap 7 11
   grab_netmap 8 12
   mask_unmask 6 10
   mask_unmask 7 11
   mask_unmask 8 12
fi
# Node 6
if [ $NODE -eq 6 ]; then   
   Net.speedo -r101000000 -I0 -l10 &
   Net.speedo -r101000000 -I1 -l14 &
   Net.speedo -r101000000 -I2 -l13 &
   sleep 1
   grab_netmap 5 10
   grab_netmap 8 14
   grab_netmap 7 13
   mask_unmask 5 10
   mask_unmask 8 14
   mask_unmask 7 13
fi
# Node 7
if [ $NODE -eq 7 ]; then   
   Net.speedo -r101000000 -I0 -l11 &
   Net.speedo -r101000000 -I1 -l15 &
   Net.speedo -r101000000 -I2 -l13 &
   sleep 1
   grab_netmap 5 11
   grab_netmap 8 15
   grab_netmap 6 13
   mask_unmask 5 11
   mask_unmask 8 15
   mask_unmask 6 13
fi
# Node 8
if [ $NODE -eq 8 ]; then   
   Net.speedo -r101000000 -I0 -l12 &
   Net.speedo -r101000000 -I1 -l14 &
   Net.speedo -r101000000 -I2 -l15 &
   sleep 1
   grab_netmap 5 12
   grab_netmap 6 14
   grab_netmap 7 15
   mask_unmask 5 12
   mask_unmask 6 14
   mask_unmask 7 15
fi
# Node 9
if [ $NODE -eq 9 ]; then   
   Net.speedo -r101000000 -I0 -l16 &
   Net.speedo -r101000000 -I1 -l17 &
   Net.speedo -r101000000 -I2 -l18 &
   sleep 1
   grab_netmap 10 16
   grab_netmap 11 17
   grab_netmap 12 18
   mask_unmask 10 16
   mask_unmask 11 17
   mask_unmask 12 18
fi
# Node 10
if [ $NODE -eq 10 ]; then   
   Net.speedo -r101000000 -I0 -l16 &
   Net.speedo -r101000000 -I1 -l19 &
   Net.speedo -r101000000 -I2 -l20 &
   sleep 1
   grab_netmap 9 16
   grab_netmap 11 19
   grab_netmap 12 20
   mask_unmask 9 16
   mask_unmask 11 19
   mask_unmask 12 20
fi
# Node 11
if [ $NODE -eq 11 ]; then   
   Net.speedo -r101000000 -I0 -l17 &
   Net.speedo -r101000000 -I1 -l19 &
   Net.speedo -r101000000 -I2 -l21 &
   sleep 1
   grab_netmap 9 17
   grab_netmap 10 19
   grab_netmap 12 21
   mask_unmask 9 17
   mask_unmask 10 19
   mask_unmask 12 21
fi
# Node 12
if [ $NODE -eq 12 ]; then   
   Net.speedo -r101000000 -I0 -l18 &
   Net.speedo -r101000000 -I1 -l20 &
   Net.speedo -r101000000 -I2 -l21 &
   sleep 1
   grab_netmap 9 18
   grab_netmap 10 20
   grab_netmap 11 21
   mask_unmask 9 18
   mask_unmask 10 20
   mask_unmask 11 21
fi
# Node 13
if [ $NODE -eq 13 ]; then   
   Net.speedo -r101000000 -I0 -l22 -D 0x1209 &
   Net.speedo -r101000000 -I1 -l23 -D 0x1209 &
   Net.speedo -r101000000 -I2 -l24 -D 0x1209 &
   sleep 1
   grab_netmap 14 22
   grab_netmap 15 23
   grab_netmap 16 24
   mask_unmask 14 22
   mask_unmask 15 23
   mask_unmask 16 24
fi
# Node 14
if [ $NODE -eq 14 ]; then   
   Net.speedo -r101000000 -I0 -l22 -D 0x1209 &
   Net.speedo -r101000000 -I1 -l25 -D 0x1209 &
   Net.speedo -r101000000 -I2 -l26 -D 0x1209 &
   sleep 1
   grab_netmap 13 22
   grab_netmap 15 25
   grab_netmap 16 26
   mask_unmask 13 22
   mask_unmask 15 25
   mask_unmask 16 26
fi
# Node 15
if [ $NODE -eq 15 ]; then   
   Net.speedo -r101000000 -I0 -l23 -D 0x1209 &
   Net.speedo -r101000000 -I1 -l25 -D 0x1209 &
   Net.speedo -r101000000 -I2 -l27 -D 0x1209 &
   sleep 1
   grab_netmap 13 23
   grab_netmap 14 25
   grab_netmap 16 27
   mask_unmask 13 23
   mask_unmask 14 25
   mask_unmask 16 27
fi
# Node 16
if [ $NODE -eq 16 ]; then   
   Net.speedo -r101000000 -I0 -l24 -D 0x1209 &
   Net.speedo -r101000000 -I1 -l26 -D 0x1209 &
   Net.speedo -r101000000 -I2 -l27 -D 0x1209 &
   sleep 1
   grab_netmap 13 24
   grab_netmap 14 26
   grab_netmap 15 27
   mask_unmask 13 24
   mask_unmask 14 26
   mask_unmask 15 27
fi
# Node 17
if [ $NODE -eq 17 ]; then   
   Net.speedo -r101000000 -I0 -l28 -D 0x1209 &
   Net.speedo -r101000000 -I1 -l29 -D 0x1209 &
   Net.speedo -r101000000 -I2 -l30 -D 0x1209 &
   sleep 1
   grab_netmap 18 28
   grab_netmap 19 29
   grab_netmap 20 30
   mask_unmask 18 28
   mask_unmask 19 29
   mask_unmask 20 30
fi
# Node 18
if [ $NODE -eq 18 ]; then   
   Net.speedo -r101000000 -I0 -l28 -D 0x1209 &
   Net.speedo -r101000000 -I1 -l31 -D 0x1209 &
   Net.speedo -r101000000 -I2 -l32 -D 0x1209 &
   sleep 1
   grab_netmap 17 28
   grab_netmap 19 31
   grab_netmap 20 32
   mask_unmask 17 28
   mask_unmask 19 31
   mask_unmask 20 32
fi
# Node 19
if [ $NODE -eq 19 ]; then   
   Net.speedo -r101000000 -I0 -l29 -D 0x1209 &
   Net.speedo -r101000000 -I1 -l31 -D 0x1209 &
   Net.speedo -r101000000 -I2 -l33 -D 0x1209 &
   sleep 1
   grab_netmap 17 29
   grab_netmap 18 31
   grab_netmap 20 33
   mask_unmask 17 29
   mask_unmask 18 31
   mask_unmask 20 33
fi
# Node 20
if [ $NODE -eq 20 ]; then   
   Net.speedo -r101000000 -I0 -l30 -D 0x1209 &
   Net.speedo -r101000000 -I1 -l32 -D 0x1209 &
   Net.speedo -r101000000 -I2 -l33 -D 0x1209 &
   sleep 1
   grab_netmap 17 30
   grab_netmap 18 32
   grab_netmap 19 33
   mask_unmask 17 30
   mask_unmask 18 32
   mask_unmask 19 33
fi
# Node 21
if [ $NODE -eq 21 ]; then   
   Net.speedo -r101000000 -I0 -l34 -D 0x1209 &
   Net.speedo -r101000000 -I1 -l35 -D 0x1209 &
   Net.speedo -r101000000 -I2 -l36 -D 0x1209 &
   sleep 1
   grab_netmap 22 34
   grab_netmap 23 35
   grab_netmap 24 36
   mask_unmask 22 34
   mask_unmask 23 35
   mask_unmask 24 36
fi
# Node 22
if [ $NODE -eq 22 ]; then   
   Net.speedo -r101000000 -I0 -l34 -D 0x1209 &
   Net.speedo -r101000000 -I1 -l37 -D 0x1209 &
   Net.speedo -r101000000 -I2 -l38 -D 0x1209 &
   sleep 1
   grab_netmap 21 34
   grab_netmap 23 37
   grab_netmap 24 38
   mask_unmask 21 34
   mask_unmask 23 37
   mask_unmask 24 38
fi
# Node 23
if [ $NODE -eq 23 ]; then   
   Net.speedo -r101000000 -I0 -l35 -D 0x1209 &
   Net.speedo -r101000000 -I1 -l37 -D 0x1209 &
   Net.speedo -r101000000 -I2 -l39 -D 0x1209 &
   sleep 1
   grab_netmap 21 35
   grab_netmap 22 37
   grab_netmap 24 39
   mask_unmask 21 35
   mask_unmask 22 37
   mask_unmask 24 39
fi
# Node 24
if [ $NODE -eq 24 ]; then   
   Net.speedo -r101000000 -I0 -l36 -D 0x1209 &
   Net.speedo -r101000000 -I1 -l38 -D 0x1209 &
   Net.speedo -r101000000 -I2 -l39 -D 0x1209 &
   sleep 1
   grab_netmap 21 36
   grab_netmap 22 38
   grab_netmap 23 39
   mask_unmask 21 36
   mask_unmask 22 38
   mask_unmask 23 39
fi




